// ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡πâ‡∏î JavaScript ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå HTML ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

// Configuration - ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Google Apps Script
const ADMIN_PASSWORD = 'admin1234';
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbwNQ3BTN8Fwk17aj3c61Bo6Z5S4MPb8bv8Ba-2Wm6AP2xUSMGK1za3v4swVMlLfqRz7NQ/exec'; // ‡πÉ‡∏™‡πà URL ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Deploy

// Storage for registrations
let registrations = JSON.parse(localStorage.getItem('registrations') || '[]');

// Navigation Functions
function hideAllSections() {
    const sections = ['studentForm', 'adminLogin', 'adminPanel', 'statusCheck'];
    sections.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'none';
        }
    });
}

function showStudentForm() {
    hideAllSections();
    const element = document.getElementById('studentForm');
    if (element) {
        element.style.display = 'block';
    }
}

function showAdminLogin() {
    hideAllSections();
    const element = document.getElementById('adminLogin');
    if (element) {
        element.style.display = 'block';
    }
}

function showStatus() {
    hideAllSections();
    const element = document.getElementById('statusCheck');
    if (element) {
        element.style.display = 'block';
    }
}

// Image Preview
document.addEventListener('DOMContentLoaded', function() {
    const photoInput = document.getElementById('photo');
    if (photoInput) {
        photoInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('imagePreview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
                
                // Update label
                const label = document.querySelector('.file-upload-label');
                if (label) {
                    label.textContent = `üì∑ ${file.name}`;
                }
            }
        });
    }
    
    // Initialize
    showStudentForm();
    
    // ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
    setTimeout(() => {
        testConnection();
    }, 1000);
});

// Student Registration Form
document.addEventListener('DOMContentLoaded', function() {
    const registrationForm = document.getElementById('registrationForm');
    if (registrationForm) {
        registrationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());
            
            // Convert photo to base64
            const photoFile = document.getElementById('photo').files[0];
            if (photoFile) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    data.photo = e.target.result;
                    submitRegistration(data);
                };
                reader.readAsDataURL(photoFile);
            } else {
                submitRegistration(data);
            }
        });
    }
});

async function submitRegistration(data) {
    try {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        const registration = {
            id: Date.now().toString(),
            ...data,
            status: 'pending',
            timestamp: new Date().toISOString(),
            statusText: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
            action: 'submit'
        };

        // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô localStorage
        registrations.push(registration);
        localStorage.setItem('registrations', JSON.stringify(registrations));

        // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script
        const success = await sendToGoogleAppsScript(registration);

        if (success) {
            showNotification('‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'success');
            
            // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°
            document.getElementById('registrationForm').reset();
            const preview = document.getElementById('imagePreview');
            if (preview) preview.innerHTML = '';
            const label = document.querySelector('.file-upload-label');
            if (label) label.textContent = 'üì∑ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û';
        } else {
            showNotification('‚ö†Ô∏è ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
        }
        
    } catch (error) {
        console.error('Error in submitRegistration:', error);
        showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script
async function sendToGoogleAppsScript(data) {
    try {
        console.log('Sending data to Google Apps Script:', data);
        console.log('URL:', GOOGLE_SHEET_URL);
        
        if (!GOOGLE_SHEET_URL || GOOGLE_SHEET_URL === 'YOUR_NEW_GOOGLE_APPS_SCRIPT_URL') {
            throw new Error('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GOOGLE_SHEET_URL ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
        }
        
        const response = await fetch(GOOGLE_SHEET_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        console.log('Response status:', response.status);
        
        if (response.ok) {
            const result = await response.text();
            console.log('Google Apps Script response:', result);
            
            try {
                const jsonResult = JSON.parse(result);
                if (jsonResult.status === 'success') {
                    console.log('Data sent successfully');
                    return true;
                } else {
                    console.error('Server error:', jsonResult.message);
                    showNotification('‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + jsonResult.message, 'error');
                    return false;
                }
            } catch (parseError) {
                console.log('Response is not JSON, but request succeeded');
                return true;
            }
        } else {
            const errorText = await response.text();
            console.error('HTTP error:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
    } catch (error) {
        console.error('Error sending to Google Apps Script:', error);
        showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + error.message, 'error');
        return false;
    }
}

// Admin Login
document.addEventListener('DOMContentLoaded', function() {
    const adminLoginForm = document.getElementById('adminLoginForm');
    if (adminLoginForm) {
        adminLoginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const adminId = document.getElementById('adminId').value;
            
            if (adminId === ADMIN_PASSWORD) {
                hideAllSections();
                const adminPanel = document.getElementById('adminPanel');
                if (adminPanel) {
                    adminPanel.style.display = 'block';
                }
                loadRegistrations();
                showNotification('‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
            } else {
                showNotification('‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
            
            document.getElementById('adminLoginForm').reset();
        });
    }
});

// Load registrations for admin
function loadRegistrations() {
    const registrationsList = document.getElementById('registrationsList');
    if (!registrationsList) return;
    
    registrationsList.innerHTML = '';

    if (registrations.length === 0) {
        registrationsList.innerHTML = '<p style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</p>';
        return;
    }

    registrations.forEach(registration => {
        const registrationItem = document.createElement('div');
        registrationItem.className = 'registration-item';
        registrationItem.innerHTML = `
            <h3>${registration.firstName} ${registration.lastName}</h3>
            <div class="registration-details">
                <div><strong>‡∏£‡∏´‡∏±‡∏™:</strong> ${registration.studentId}</div>
                <div><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${registration.studentNumber}</div>
                <div><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${registration.classroom}</div>
                <div><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</strong> ${registration.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="status-badge status-${registration.status}">${registration.statusText}</span></div>
                <div><strong>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠:</strong> ${registration.teacherSignature || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(registration.timestamp).toLocaleDateString('th-TH')}</div>
                ${registration.photo ? `
                <div class="registration-photo">
                    <img src="${registration.photo}" alt="‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢">
                </div>` : ''}
            </div>
            ${registration.status === 'pending' ? `
            <div class="admin-actions">
                <button class="btn-success" onclick="approveRegistration('${registration.id}')">‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
                <button class="btn-danger" onclick="rejectRegistration('${registration.id}')">‚ùå ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</button>
            </div>` : ''}
        `;
        registrationsList.appendChild(registrationItem);
    });
}

// Approve registration
async function approveRegistration(id) {
    const registration = registrations.find(r => r.id === id);
    if (registration) {
        registration.status = 'approved';
        registration.statusText = '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
        registration.action = 'approved';
        localStorage.setItem('registrations', JSON.stringify(registrations));
        
        // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script
        await sendToGoogleAppsScript(registration);
        
        loadRegistrations();
        showNotification('‚úÖ ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }
}

// Reject registration
async function rejectRegistration(id) {
    const registration = registrations.find(r => r.id === id);
    if (registration) {
        registration.status = 'rejected';
        registration.statusText = '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
        registration.action = 'rejected';
        localStorage.setItem('registrations', JSON.stringify(registrations));
        
        // ‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏õ‡∏¢‡∏±‡∏á Google Apps Script
        await sendToGoogleAppsScript(registration);
        
        loadRegistrations();
        showNotification('‚úÖ ‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
    }
}

// Status Check
document.addEventListener('DOMContentLoaded', function() {
    const statusForm = document.getElementById('statusForm');
    if (statusForm) {
        statusForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('checkStudentId').value;
            const studentRegistrations = registrations.filter(r => r.studentId === studentId);
            
            const statusResult = document.getElementById('statusResult');
            if (!statusResult) return;
            
            if (studentRegistrations.length === 0) {
                statusResult.innerHTML = '<div style="text-align: center; color: #666; margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 10px;">‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™: ' + studentId + '</div>';
                return;
            }

            let resultHTML = '<h3 style="margin-top: 20px; color: #333;">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h3>';
            studentRegistrations.forEach(registration => {
                resultHTML += `
                    <div class="registration-item" style="margin-top: 15px;">
                        <div class="registration-details">
                            <div><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${registration.firstName} ${registration.lastName}</div>
                            <div><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${registration.studentNumber}</div>
                            <div><strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${registration.classroom}</div>
                            <div><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</strong> ${registration.points} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div>
                            <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="status-badge status-${registration.status}">${registration.statusText}</span></div>
                            <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(registration.timestamp).toLocaleDateString('th-TH')}</div>
                            <div><strong>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠:</strong> ${registration.teacherSignature || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</div>
                        </div>
                    </div>
                `;
            });
            
            statusResult.innerHTML = resultHTML;
        });
    }
});

// Utility Functions
function refreshRegistrations() {
    loadRegistrations();
    showNotification('üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
}

function logout() {
    hideAllSections();
    showStudentForm();
    showNotification('üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
}

function showNotification(message, type) {
    let notification = document.getElementById('notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = 'notification';
        document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠
async function testConnection() {
    try {
        if (!GOOGLE_SHEET_URL || GOOGLE_SHEET_URL === 'YOUR_NEW_GOOGLE_APPS_SCRIPT_URL') {
            console.warn('Google Apps Script URL not configured');
            return;
        }
        
        console.log('Testing connection to:', GOOGLE_SHEET_URL);
        
        const response = await fetch(GOOGLE_SHEET_URL, {
            method: 'GET'
        });
        
        if (response.ok) {
            const result = await response.text();
            console.log('Connection test successful:', result);
        } else {
            console.error('Connection test failed:', response.status);
        }
    } catch (error) {
        console.error('Connection test error:', error);
    }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
async function sendTestData() {
    const testData = {
        studentId: 'TEST001',
        studentNumber: '1',
        firstName: '‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
        lastName: '‡∏£‡∏∞‡∏ö‡∏ö',
        classroom: '‡∏°.1/1',
        points: '1',
        teacherSignature: '‡∏Ñ‡∏£‡∏π‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
        photo: null,
        action: 'submit'
    };
    
    console.log('Sending test data:', testData);
    const success = await sendToGoogleAppsScript(testData);
    
    if (success) {
        showNotification('‚úÖ ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
    } else {
        showNotification('‚ùå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
    }
}
